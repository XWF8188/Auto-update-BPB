name: Sync Latest Release from Upstream

on:
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘
  workflow_run:          # Auto Update _worker.js æˆåŠŸåè§¦å‘
    workflows: ["Auto Update _worker.js"]  # å¿…é¡»å’Œ Auto Update workflow çš„ name ä¸€è‡´
    types:
      - completed

jobs:
  sync:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Check upstream latest release
        id: check
        env:
          UPSTREAM: bia-pain-bache/BPB-Worker-Panel
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–° release
          upstream=$(gh api repos/$UPSTREAM/releases/latest)
          up_tag=$(echo "$upstream" | jq -r .tag_name)

          echo "upstream_tag=$up_tag" >> $GITHUB_OUTPUT

          # è·å–è‡ªå·±ä»“åº“æœ€æ–° releaseï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
          my_latest=$(gh release list --limit 1 | awk '{print $1}')
          echo "my_tag=$my_latest" >> $GITHUB_OUTPUT

          if [ "$up_tag" = "$my_latest" ]; then
            echo "âš ï¸ ä¸Šæ¸¸æ²¡æœ‰æ–° releaseï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi

      - name: Sync latest release
        if: steps.check.outputs.upstream_tag != steps.check.outputs.my_tag
        env:
          UPSTREAM: bia-pain-bache/BPB-Worker-Panel
        run: |
          release=$(gh api repos/$UPSTREAM/releases/latest)

          tag=$(echo "$release" | jq -r .tag_name)
          name=$(echo "$release" | jq -r .name)
          body=$(echo "$release" | jq -r .body)
          draft=$(echo "$release" | jq -r .draft)
          prerelease=$(echo "$release" | jq -r .prerelease)

          echo "ğŸ”„ åŒæ­¥æœ€æ–° release: $tag ($name)"

          # é…ç½® git ç”¨æˆ·ä¿¡æ¯ï¼ˆé¿å… author identity unknownï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ‹‰å–ä¸Šæ¸¸ tag å¹¶åˆ‡æ¢
          git fetch https://github.com/$UPSTREAM.git tag $tag || true
          git checkout $tag

          # åˆ é™¤ä¸Šæ¸¸ workflowsï¼Œé¿å… push è¢«æ‹’ç»
          rm -rf .github/workflows

          # å¼ºåˆ¶æ¨é€ tag åˆ°è‡ªå·±ä»“åº“
          git tag -f $tag
          git push origin $tag --force

          # åˆ›å»º release
          gh release create "$tag" \
            --title "$name" \
            --notes "$body" \
            $( [ "$draft" = "true" ] && echo "--draft" ) \
            $( [ "$prerelease" = "true" ] && echo "--prerelease" )

          # ä¸‹è½½å¹¶ä¸Šä¼ é™„ä»¶
          for asset_id in $(echo "$release" | jq -r '.assets[].id'); do
            asset_name=$(echo "$release" | jq -r ".assets[] | select(.id==$asset_id) | .name")
            asset_url=$(echo "$release" | jq -r ".assets[] | select(.id==$asset_id) | .url")

            echo "â¬‡ï¸ ä¸‹è½½é™„ä»¶: $asset_name"
            curl -sL -H "Accept: application/octet-stream" \
                 -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 "$asset_url" -o "$asset_name"

            echo "â¬†ï¸ ä¸Šä¼ é™„ä»¶: $asset_name"
            gh release upload "$tag" "$asset_name" --clobber
          done
